<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Malinoise Web App - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
      <!-- Socket.IO para actualizaciones en tiempo real -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    
    <!-- jsPDF para generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Auth API -->
    <script src="js/auth-api.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 
    Chosen Palette: Calm Harmony
    - Background: bg-slate-50 (#F8FAFC)
    - Text: text-slate-800 (#1E293B), text-slate-600 (#475569)
    - Primary Accent: bg-teal-600 (#0D9488), text-white
    - Secondary Accent: bg-teal-200 (#B2F2EE) for lighter accents
    -->
    
    <!-- 
    Application Structure Plan: 
    Esta SPA representa la "versión web" de Malinoise, a la que el usuario accedería después de un inicio de sesión exitoso. Se centra en el dashboard de negocio.
    1.  **Cabecera Minimalista:** Un título claro de la aplicación y un botón para cerrar sesión, enfocado en la funcionalidad.
    2.  **Sección Principal (Dashboard):** Contiene un resumen de métricas clave (Ventas, Productos, Ganancias) mostradas en tarjetas.
    3.  **Navegación por Pestañas:** Permite al usuario alternar entre las vistas principales del dashboard: "Ventas", "Inventario" y "Proyecciones". Esto organiza el contenido y facilita la navegación sin recargar la página.
    4.  **Sección de Ventas:** Incluye la tabla de últimas ventas y el formulario para registrar nuevas ventas.
    5.  **Sección de Inventario:** Nueva sección con una tabla detallada de productos, un formulario para añadir nuevos productos, y un formulario para eliminar stock. La gestión del stock se simula en tiempo real con las ventas.
    6.  **Sección de Proyecciones:** Nueva sección para configurar un negocio (nombre, inversión, gastos, ingresos) y calcular proyecciones financieras clave como el punto de equilibrio y el tiempo de recuperación de la inversión. Se ha añadido una calculadora de inversión inicial basada en gastos detallados.
    Esta estructura está diseñada para ser una interfaz de trabajo concisa y eficiente, asumiendo que el usuario ya ha pasado por la fase de autenticación y necesita herramientas para gestionar su negocio.
    -->
    
    <!--
    Visualization & Content Choices:
    - **Key Metrics -> Goal: Inform -> Presentation: Info Cards.** Displays total sales, products in stock, net profit. Justification: Quick, at-a- glance overview of business health. Method: HTML/Tailwind.
    - **Tab Navigation -> Goal: Organize -> Presentation: Buttons/Links.** Allows switching between sales, inventory, and projections views. Interaction: Click to change visible content. Justification: Improves content organization and user experience for a single-page app. Method: HTML/Tailwind, JS for display logic.
    - **Recent Sales -> Goal: Inform/Manage -> Presentation: Data Table.** Lists recent sales transactions. Justification: Provides granular detail of recent activity. Method: HTML/Tailwind table, JS for dynamic row population.
    - **New Sale Entry -> Goal: Manage -> Presentation: Form.** Allows user to input new sale data. Interaction: Input fields, add button, form validation, update metrics and inventory. Justification: Demonstrates core business management functionality. Method: HTML/Tailwind form, JS for handling input, updating simulated data, and displaying messages.
    - **Detailed Inventory -> Goal: Inform/Manage -> Presentation: Data Table.** Lists all products with stock details. Justification: Provides comprehensive overview of stock. Method: HTML/Tailwind table, JS for dynamic row population.
    - **Add Product Entry -> Goal: Manage -> Presentation: Form.** Allows user to input new product data. Interaction: Input fields, add button, form validation, update inventory. Justification: Supports inventory management. Method: HTML/Tailwind form, JS for handling input, updating simulated data, and displaying messages.
    - **Remove Stock Entry -> Goal: Manage -> Presentation: Form.** Allows user to reduce stock of an existing product. Interaction: Input fields (SKU, quantity), remove button, validation. Justification: Provides comprehensive inventory control. Method: HTML/Tailwind form, JS for handling input, updating simulated data, and displaying messages.
    - **Business Projections -> Goal: Analyze/Plan -> Presentation: Input Form & Result Display.** Allows input of business financials (investment, expenses, revenue) and displays calculated metrics like break-even point and recovery time. Justification: Provides strategic planning tools. Method: HTML/Tailwind forms and text displays, JS for calculations and data persistence.
    - **Initial Investment Calculator -> Goal: Plan -> Presentation: Form for individual expenses & summary.** Allows users to detail initial expenses and calculates a total investment. Interaction: Add expense button, auto-calculation. Justification: Provides a more granular and realistic way to define initial investment. Method: HTML/Tailwind form/list, JS for expense management and total calculation.
    -->
    
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/custom.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
            color: #1E293B;
        }
        .form-message {
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .form-message.success {
            background-color: #D1FAE5; /* green-100 */
            color: #065F46; /* green-800 */
        }
        .form-message.error {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
        }
        .tab-button.active {
            border-color: #0D9488;
            color: #0D9488;
            background-color: #F0FDFA; /* teal-50 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Responsive improvements for dashboard */
        @media (max-width: 640px) {
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .dashboard-card {
                padding: 1.25rem;
            }
            
            .dashboard-metric {
                font-size: 2rem;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            .tab-navigation {
                justify-content: center;
                gap: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="bg-slate-50">    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto container-padding py-3 flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold text-teal-600">Malinoise Web App</h1>
              <div class="flex items-center space-x-2 sm:space-x-4">
                <!-- Selector de divisas -->
                <div class="flex items-center space-x-2">
                    <i class="fas fa-coins text-slate-500 text-sm"></i>
                    <select id="currency-selector" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" aria-label="Selector de divisa">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (€)</option>
                        <option value="GBP">GBP (£)</option>
                        <option value="JPY">JPY (¥)</option>
                        <option value="CAD">CAD (C$)</option>
                        <option value="AUD">AUD (A$)</option>
                        <option value="CHF">CHF (₣)</option>
                        <option value="MXN">MXN ($)</option>
                        <option value="BRL">BRL (R$)</option>
                        <option value="ARS">ARS ($)</option>
                        <option value="COP">COP ($)</option>
                        <option value="PEN">PEN (S/)</option>
                    </select>
                </div>
                
                <!-- Botón de descarga de reportes -->
                <button id="download-pdf-btn" class="bg-green-600 text-white font-semibold px-3 py-2 rounded-lg hover:bg-green-700 transition-colors shadow text-sm" title="Descargar Reporte PDF">
                    <i class="fas fa-file-pdf mr-1"></i> 
                    <span class="hidden sm:inline">PDF</span>
                </button>
                
                <!-- Acceso a administración (solo CEO) -->
                <a href="/admin" id="admin-link" class="hidden bg-blue-600 text-white font-semibold px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow text-sm" title="Administrar Base de Datos">
                    <i class="fas fa-database mr-1"></i> Admin
                </a>
                
                <!-- Botón de cerrar sesión -->
                <button onclick="logout()" class="bg-slate-700 text-white font-semibold px-3 sm:px-4 py-2 rounded-lg hover:bg-slate-800 transition-colors shadow text-sm sm:text-base">
                    <i class="fas fa-sign-out-alt mr-1"></i> Salir
                </button>
            </div>
        </nav>
    </header>

    <main id="dashboard" class="section-padding py-8 sm:py-10">
        <div class="container mx-auto container-padding">            <div class="text-center mb-8 sm:mb-10">
                <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-slate-800 mb-2 sm:mb-3">¡Bienvenido a tu Dashboard Web!</h2>
                <p class="text-sm sm:text-base lg:text-lg text-slate-600">
                    Gestiona tu negocio de forma eficiente. Los datos se sincronizan con tu aplicación móvil.
                </p>
                <p id="userInfo" class="text-xs sm:text-sm text-slate-500 mt-2"></p>
            </div>            <div class="metrics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 mb-8 sm:mb-12">
                <div class="dashboard-card bg-white p-4 sm:p-6 rounded-xl shadow-lg text-center">
                    <p class="text-xs sm:text-sm text-slate-600">Ventas Totales (Mes)</p>
                    <p id="totalSales" class="dashboard-metric text-3xl sm:text-4xl font-bold text-teal-600 mt-2" data-amount="5000">$5,000.00</p>
                </div>
                <div class="dashboard-card bg-white p-4 sm:p-6 rounded-xl shadow-lg text-center">
                    <p class="text-xs sm:text-sm text-slate-600">Productos en Stock</p>
                    <p id="totalProductsCount" class="dashboard-metric text-3xl sm:text-4xl font-bold text-teal-600 mt-2">0</p>
                </div>
                <div class="dashboard-card bg-white p-4 sm:p-6 rounded-xl shadow-lg text-center lg:col-span-1 md:col-span-2 lg:col-span-1">
                    <p class="text-xs sm:text-sm text-slate-600">Ganancia Neta (Mes)</p>
                    <p id="netProfit" class="dashboard-metric text-3xl sm:text-4xl font-bold text-teal-600 mt-2" data-amount="1500">$1,500.00</p>
                </div>
            </div>

            <!-- Navegación por pestañas -->
            <div class="tab-navigation flex justify-center mb-4 sm:mb-6 flex-wrap">
                <button id="tabVentas" class="tab-button px-4 sm:px-6 py-2 sm:py-3 border-b-2 border-transparent text-slate-600 hover:border-teal-600 hover:text-teal-600 transition-colors active text-sm sm:text-base">Ventas</button>
                <button id="tabInventario" class="tab-button px-4 sm:px-6 py-2 sm:py-3 border-b-2 border-transparent text-slate-600 hover:border-teal-600 hover:text-teal-600 transition-colors text-sm sm:text-base">Inventario</button>
                <button id="tabProyecciones" class="tab-button px-4 sm:px-6 py-2 sm:py-3 border-b-2 border-transparent text-slate-600 hover:border-teal-600 hover:text-teal-600 transition-colors text-sm sm:text-base">Proyecciones</button>
            </div>

            <!-- Contenido de la pestaña de Ventas -->
            <div id="contentVentas" class="tab-content active">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8 sm:mb-12">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-4 sm:mb-6">Últimas Ventas</h4>
                    <div class="table-responsive">
                        <table class="w-full text-left table-auto min-w-full">
                            <thead>
                                <tr class="bg-slate-50 text-slate-600 uppercase text-xs sm:text-sm leading-normal">
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left rounded-tl-lg">Producto</th>
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left">Cantidad</th>
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left">Precio</th>
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left rounded-tr-lg">Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody" class="text-slate-700 text-xs sm:text-sm font-light">
                                <!-- Filas de ventas se insertarán aquí por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-3 sm:mb-4">Registrar Nueva Venta</h4>
                    <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label for="newSaleProduct" class="block text-sm font-medium text-slate-700">Producto</label>
                            <input type="text" id="newSaleProduct" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Nombre del producto">
                        </div>
                        <div>
                            <label for="newSaleQuantity" class="block text-sm font-medium text-slate-700">Cantidad</label>
                            <input type="number" id="newSaleQuantity" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" value="1" min="1">
                        </div>                        <div>
                            <label for="newSalePrice" class="block text-sm font-medium text-slate-700">Precio por unidad</label>
                            <input type="number" id="newSalePrice" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. 25.00" step="0.01">
                        </div>
                        <div class="col-span-full">
                            <button id="addSaleButton" class="w-full bg-teal-600 text-white font-semibold py-2 sm:py-3 rounded-lg hover:bg-teal-700 transition-colors shadow text-sm sm:text-base">
                                Añadir Venta
                            </button>
                            <div id="addSaleMessage" class="form-message hidden mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de la pestaña de Inventario (Nueva Sección) -->
            <div id="contentInventario" class="tab-content">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8 sm:mb-12">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-4 sm:mb-6">Inventario Detallado</h4>
                    <div class="table-responsive">
                        <table class="w-full text-left table-auto min-w-full">
                            <thead>
                                <tr class="bg-slate-50 text-slate-600 uppercase text-xs sm:text-sm leading-normal">
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left rounded-tl-lg">Producto</th>
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left">SKU</th>
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left">Stock</th>
                                    <th class="py-2 sm:py-3 px-3 sm:px-6 text-left rounded-tr-lg">Precio Unitario (€)</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="text-slate-700 text-xs sm:text-sm font-light">
                                <!-- Filas de productos se insertarán aquí por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8 sm:mb-12">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-3 sm:mb-4">Añadir Nuevo Producto</h4>
                    <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label for="newProduct" class="block text-sm font-medium text-slate-700">Nombre del Producto</label>
                            <input type="text" id="newProduct" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. Camiseta Azul">
                        </div>
                        <div>
                            <label for="newProductSKU" class="block text-sm font-medium text-slate-700">SKU</label>
                            <input type="text" id="newProductSKU" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. CAM-AZUL-L">
                        </div>
                        <div>
                            <label for="newProductStock" class="block text-sm font-medium text-slate-700">Stock Inicial</label>
                            <input type="number" id="newProductStock" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" value="0" min="0">
                        </div>
                        <div>
                            <label for="newProductPrice" class="block text-sm font-medium text-slate-700">Precio de Venta (€)</label>
                            <input type="number" id="newProductPrice" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. 29.99" step="0.01">
                        </div>
                        <div class="col-span-full">
                            <button id="addProductButton" class="w-full bg-teal-600 text-white font-semibold py-2 sm:py-3 rounded-lg hover:bg-teal-700 transition-colors shadow text-sm sm:text-base">
                                Añadir Producto
                            </button>
                            <div id="addProductMessage" class="form-message hidden mt-3"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-3 sm:mb-4">Eliminar Stock de Producto</h4>
                    <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label for="removeProductSKU" class="block text-sm font-medium text-slate-700">SKU del Producto</label>
                            <input type="text" id="removeProductSKU" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. CAM-AZUL-L">
                        </div>
                        <div>
                            <label for="removeQuantity" class="block text-sm font-medium text-slate-700">Cantidad a Eliminar</label>
                            <input type="number" id="removeQuantity" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" value="1" min="1">
                        </div>
                        <div class="col-span-full">
                            <button id="removeStockButton" class="w-full bg-red-600 text-white font-semibold py-2 sm:py-3 rounded-lg hover:bg-red-700 transition-colors shadow text-sm sm:text-base">
                                Eliminar Stock
                            </button>
                            <div id="removeStockMessage" class="form-message hidden mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de la pestaña de Proyecciones (Nueva Sección) -->
            <div id="contentProyecciones" class="tab-content">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8 sm:mb-12">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-3 sm:mb-4">Configurar Negocio y Proyecciones</h4>
                    <p class="text-xs sm:text-sm text-slate-600 mb-4 sm:mb-6">Ingresa los datos de tu negocio para obtener proyecciones financieras.</p>
                    <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label for="businessName" class="block text-sm font-medium text-slate-700">Nombre del Negocio</label>
                            <input type="text" id="businessName" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Mi Empresa S.L.">
                        </div>
                        <div>
                            <label for="monthlyExpenses" class="block text-sm font-medium text-slate-700">Gastos Mensuales Estimados (€)</label>
                            <input type="number" id="monthlyExpenses" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. 1500" step="0.01" min="0">
                        </div>
                        <div>
                            <label for="monthlyRevenue" class="block text-sm font-medium text-slate-700">Ingresos Mensuales Estimados (€)</label>
                            <input type="number" id="monthlyRevenue" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. 2000" step="0.01" min="0">
                        </div>
                        <div class="col-span-full">
                            <button id="calculateProjectionsButton" class="w-full bg-teal-600 text-white font-semibold py-2 sm:py-3 rounded-lg hover:bg-teal-700 transition-colors shadow text-sm sm:text-base">
                                Calcular Proyecciones
                            </button>
                            <div id="projectionMessage" class="form-message hidden mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Nueva Sección: Calculadora de Inversión Inicial -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8 sm:mb-12">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-3 sm:mb-4">Calculadora de Inversión Inicial</h4>
                    <p class="text-xs sm:text-sm text-slate-600 mb-4 sm:mb-6">Detalla tus gastos de inversión inicial para calcular el total.</p>
                    <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 mb-4">
                        <div>
                            <label for="initialExpenseName" class="block text-sm font-medium text-slate-700">Nombre del Gasto</label>
                            <input type="text" id="initialExpenseName" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. Maquinaria, Stock inicial">
                        </div>
                        <div>
                            <label for="initialExpenseAmount" class="block text-sm font-medium text-slate-700">Monto (€)</label>
                            <input type="number" id="initialExpenseAmount" class="mt-1 block w-full p-2 sm:p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm sm:text-base" placeholder="Ej. 5000" step="0.01" min="0">
                        </div>
                        <div class="col-span-full">
                            <button id="addInitialExpenseButton" class="w-full bg-blue-600 text-white font-semibold py-2 sm:py-3 rounded-lg hover:bg-blue-700 transition-colors shadow text-sm sm:text-base">
                                Añadir Gasto de Inversión
                            </button>
                            <div id="addInitialExpenseMessage" class="form-message hidden mt-3"></div>
                        </div>
                    </div>
                    <div class="mt-4 sm:mt-6">
                        <h5 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">Gastos de Inversión Añadidos:</h5>
                        <ul id="initialExpensesList" class="space-y-2 text-slate-700 text-sm sm:text-base">
                            <!-- Los gastos de inversión inicial se insertarán aquí -->
                        </ul>
                        <p class="text-base sm:text-lg font-bold text-slate-800 mt-4">Total Inversión Inicial Calculada: <span id="calculatedInitialInvestment">€0.00</span></p>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-3 sm:mb-4">Resultados de Proyección</h4>
                    <div id="projectionResults" class="space-y-3 sm:space-y-4 text-sm sm:text-base">
                        <p class="text-slate-700"><span class="font-semibold">Negocio Actual:</span> <span id="displayBusinessName">N/A</span></p>
                        <p class="text-slate-700"><span class="font-semibold">Inversión Inicial:</span> <span id="displayInitialInvestment">€0.00</span></p>
                        <p class="text-slate-700"><span class="font-semibold">Gastos Mensuales:</span> <span id="displayMonthlyExpenses">€0.00</span></p>
                        <p class="text-slate-700"><span class="font-semibold">Ingresos Mensuales:</span> <span id="displayMonthlyRevenue">€0.00</span></p>
                        <hr class="border-slate-200">
                        <p class="text-slate-800 text-base sm:text-lg"><span class="font-semibold">Beneficio Mensual Proyectado:</span> <span id="displayMonthlyProfit" class="font-bold">€0.00</span></p>
                        <p class="text-slate-800 text-base sm:text-lg"><span class="font-semibold">Beneficio Anual Proyectado:</span> <span id="displayAnnualProfit" class="font-bold">€0.00</span></p>
                        <p class="text-slate-800 text-base sm:text-lg"><span class="font-semibold">Punto de Equilibrio Mensual:</span> <span id="displayBreakEvenPoint" class="font-bold">N/A</span></p>
                        <p class="text-slate-800 text-base sm:text-lg"><span class="font-semibold">Tiempo de Recuperación de Inversión:</span> <span id="displayRecoveryTime" class="font-bold">N/A</span></p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8 sm:mt-12">
                <button id="logoutButton" class="bg-slate-700 text-white font-semibold px-6 sm:px-8 py-2 sm:py-3 rounded-lg hover:bg-slate-800 transition-colors shadow text-sm sm:text-base">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-slate-800 text-white py-6 sm:py-8">
        <div class="container mx-auto container-padding text-center text-slate-400">
            <p class="text-sm sm:text-base">&copy; 2025 Malinoise. Web App de Negocios.</p>
        </div>
    </footer>

    <script>        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si el usuario está autenticado usando la API
            if (!window.authAPI || !window.authAPI.isAuthenticated()) {
                // Si no está autenticado, limpiar datos y redirigir
                if (window.authAPI) {
                    window.authAPI.clearAuthData();
                }
                alert('Debes iniciar sesión para acceder al dashboard.');
                window.location.href = '/';
                return;
            }

            // Obtener datos del usuario
            const userEmail = localStorage.getItem('userEmail');
            const userName = localStorage.getItem('userName');// Mostrar mensaje de bienvenida personalizado
            const welcomeMessage = document.querySelector('main h2');
            const userInfoElement = document.getElementById('userInfo');
            
            if (welcomeMessage) {
                const displayName = userName || userEmail.split('@')[0];
                welcomeMessage.textContent = `¡Bienvenido, ${displayName}!`;
            }

            // Mostrar información adicional del usuario
            if (userInfoElement) {
                const loginMethod = localStorage.getItem('loginMethod');
                const lastLoginDate = localStorage.getItem('lastLoginDate');
                const registrationDate = localStorage.getItem('registrationDate');
                
                let infoText = `Conectado como: ${userEmail}`;
                
                if (loginMethod === 'register' && registrationDate) {
                    const regDate = new Date(registrationDate);
                    infoText += ` • Nuevo usuario desde ${regDate.toLocaleDateString('es-ES')}`;
                } else if (lastLoginDate) {
                    const loginDate = new Date(lastLoginDate);
                    infoText += ` • Último acceso: ${loginDate.toLocaleString('es-ES')}`;
                }
                
                userInfoElement.textContent = infoText;
            }

            // Datos simulados (persisten en localStorage)
            let totalSalesAmount = parseFloat(localStorage.getItem('simulatedTotalSales')) || 5000;
            let netProfitAmount = parseFloat(localStorage.getItem('simulatedNetProfit')) || 1500;
            let simulatedSales = JSON.parse(localStorage.getItem('simulatedSales')) || [
                { product: 'Servicio Consultoría', quantity: 1, price: 2500.00, date: '2025-06-15' },
                { product: 'Producto A', quantity: 5, price: 50.00, date: '2025-06-10' },
                { product: 'Producto B', quantity: 2, price: 150.00, date: '2025-06-05' }
            ];
            let simulatedProducts = JSON.parse(localStorage.getItem('simulatedProducts')) || [
                { id: 'P001', name: 'Producto A', sku: 'SKU001', stock: 95, price: 50.00 },
                { id: 'P002', name: 'Producto B', sku: 'SKU002', stock: 118, price: 150.00 },
                { id: 'P003', name: 'Producto C', sku: 'SKU003', stock: 200, price: 25.00 },
                { id: 'S001', name: 'Servicio Consultoría', sku: 'SVC001', stock: -1, price: 2500.00 } // -1 para servicios sin stock físico
            ];

            let currentBusiness = JSON.parse(localStorage.getItem('currentBusiness')) || {
                name: 'Mi Negocio',
                initialInvestment: 0, // This will now be calculated
                monthlyExpenses: 0,
                monthlyRevenue: 0
            };

            let initialExpenses = JSON.parse(localStorage.getItem('initialExpenses')) || [
                { name: 'Licencias de Software', amount: 500 },
                { name: 'Compra de inventario inicial', amount: 3000 }
            ];


            // Elementos del Dashboard
            const totalSalesEl = document.getElementById('totalSales');
            const totalProductsCountEl = document.getElementById('totalProductsCount');
            const netProfitEl = document.getElementById('netProfit');
            const salesTableBody = document.getElementById('salesTableBody');
            const inventoryTableBody = document.getElementById('inventoryTableBody');

            // Tabs
            const tabVentasBtn = document.getElementById('tabVentas');
            const tabInventarioBtn = document.getElementById('tabInventario');
            const tabProyeccionesBtn = document.getElementById('tabProyecciones');
            const contentVentas = document.getElementById('contentVentas');
            const contentInventario = document.getElementById('contentInventario');
            const contentProyecciones = document.getElementById('contentProyecciones');

            // Elements for business projections
            const businessNameInput = document.getElementById('businessName');
            const monthlyExpensesInput = document.getElementById('monthlyExpenses');
            const monthlyRevenueInput = document.getElementById('monthlyRevenue');
            const calculateProjectionsButton = document.getElementById('calculateProjectionsButton');
            const projectionMessage = document.getElementById('projectionMessage');

            const displayBusinessName = document.getElementById('displayBusinessName');
            const displayInitialInvestment = document.getElementById('displayInitialInvestment');
            const displayMonthlyExpenses = document.getElementById('displayMonthlyExpenses');
            const displayMonthlyRevenue = document.getElementById('displayMonthlyRevenue');
            const displayMonthlyProfit = document.getElementById('displayMonthlyProfit');
            const displayAnnualProfit = document.getElementById('displayAnnualProfit');
            const displayBreakEvenPoint = document.getElementById('displayBreakEvenPoint');
            const displayRecoveryTime = document.getElementById('displayRecoveryTime');

            // Elements for initial investment calculator
            const initialExpenseNameInput = document.getElementById('initialExpenseName');
            const initialExpenseAmountInput = document.getElementById('initialExpenseAmount');
            const addInitialExpenseButton = document.getElementById('addInitialExpenseButton');
            const addInitialExpenseMessage = document.getElementById('addInitialExpenseMessage');
            const initialExpensesList = document.getElementById('initialExpensesList');
            const calculatedInitialInvestmentSpan = document.getElementById('calculatedInitialInvestment');


            // Función para calcular la inversión inicial total de los gastos añadidos
            function calculateTotalInitialInvestment() {
                return initialExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            }

            // Función para renderizar la lista de gastos de inversión inicial
            function renderInitialExpenses() {
                if (initialExpensesList) { // Defensive check
                    initialExpensesList.innerHTML = '';
                    if (initialExpenses.length === 0) {
                        initialExpensesList.innerHTML = '<li class="text-slate-500 italic">No hay gastos de inversión inicial añadidos.</li>';
                    } else {
                        initialExpenses.forEach((expense, index) => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('flex', 'justify-between', 'items-center', 'py-1');
                            listItem.innerHTML = `
                                <span>${expense.name}: €${expense.amount.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</span>
                                <button class="text-red-500 hover:text-red-700 text-sm ml-4" data-index="${index}">Eliminar</button>
                            `;
                            initialExpensesList.appendChild(listItem);
                        });

                        initialExpensesList.querySelectorAll('button').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const indexToRemove = parseInt(e.target.dataset.index);
                                initialExpenses.splice(indexToRemove, 1);
                                localStorage.setItem('initialExpenses', JSON.stringify(initialExpenses));
                                updateDashboardAndTables(); // Update all related displays
                                updateProjectionsDisplay();
                                renderInitialExpenses();
                            });
                        });
                    }
                }
                if (calculatedInitialInvestmentSpan) { // Defensive check
                    calculatedInitialInvestmentSpan.textContent = `€${calculateTotalInitialInvestment().toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
            }

            // Función para actualizar las métricas del dashboard y las tablas
            function updateDashboardAndTables() {
                if (totalSalesEl) {
                    totalSalesEl.textContent = `€${totalSalesAmount.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
                
                const currentPhysicalStock = simulatedProducts.reduce((sum, product) => {
                    return product.stock > -1 ? sum + product.stock : sum;
                }, 0);
                if (totalProductsCountEl) {
                    totalProductsCountEl.textContent = currentPhysicalStock.toLocaleString('es-ES');
                }
                
                if (netProfitEl) {
                    netProfitEl.textContent = `€${netProfitAmount.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
                
                if (salesTableBody) {
                    salesTableBody.innerHTML = '';
                    simulatedSales.forEach(sale => {
                        const row = `
                            <tr class="border-b border-slate-200 hover:bg-slate-100">
                                <td class="py-2 sm:py-3 px-3 sm:px-6">${sale.product}</td>
                                <td class="py-2 sm:py-3 px-3 sm:px-6">${sale.quantity}</td>
                                <td class="py-2 sm:py-3 px-3 sm:px-6">€${sale.price.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
                                <td class="py-2 sm:py-3 px-3 sm:px-6">${sale.date}</td>
                            </tr>
                        `;
                        salesTableBody.insertAdjacentHTML('beforeend', row);
                    });
                }

                if (inventoryTableBody) {
                    inventoryTableBody.innerHTML = '';
                    simulatedProducts.forEach(product => {
                        const stockDisplay = product.stock === -1 ? 'N/A' : product.stock.toLocaleString('es-ES');
                        const row = `
                            <tr class="border-b border-slate-200 hover:bg-slate-100">
                                <td class="py-2 sm:py-3 px-3 sm:px-6">${product.name}</td>
                                <td class="py-2 sm:py-3 px-3 sm:px-6">${product.sku}</td>
                                <td class="py-2 sm:py-3 px-3 sm:px-6">${stockDisplay}</td>
                                <td class="py-2 sm:py-3 px-3 sm:px-6">€${product.price.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
                            </tr>
                        `;
                        inventoryTableBody.insertAdjacentHTML('beforeend', row);
                    });
                }

                localStorage.setItem('simulatedTotalSales', totalSalesAmount);
                localStorage.setItem('simulatedNetProfit', netProfitAmount);
                localStorage.setItem('simulatedSales', JSON.stringify(simulatedSales));
                localStorage.setItem('simulatedProducts', JSON.stringify(simulatedProducts));
            }

            // Función para actualizar la visualización de las proyecciones
            function updateProjectionsDisplay() {
                if (businessNameInput) { // Defensive check for input elements too
                    businessNameInput.value = currentBusiness.name === 'Mi Negocio' ? '' : currentBusiness.name;
                }
                if (monthlyExpensesInput) {
                    monthlyExpensesInput.value = currentBusiness.monthlyExpenses;
                }
                if (monthlyRevenueInput) {
                    monthlyRevenueInput.value = currentBusiness.monthlyRevenue;
                }

                if (displayBusinessName) {
                    displayBusinessName.textContent = currentBusiness.name;
                }
                
                // Use the calculated initial investment
                currentBusiness.initialInvestment = calculateTotalInitialInvestment();
                if (displayInitialInvestment) {
                    displayInitialInvestment.textContent = `€${currentBusiness.initialInvestment.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
                
                if (displayMonthlyExpenses) {
                    displayMonthlyExpenses.textContent = `€${currentBusiness.monthlyExpenses.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
                if (displayMonthlyRevenue) {
                    displayMonthlyRevenue.textContent = `€${currentBusiness.monthlyRevenue.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }

                const monthlyProfit = currentBusiness.monthlyRevenue - currentBusiness.monthlyExpenses;
                const annualProfit = monthlyProfit * 12;

                if (displayMonthlyProfit) {
                    displayMonthlyProfit.textContent = `€${monthlyProfit.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
                if (displayAnnualProfit) {
                    displayAnnualProfit.textContent = `€${annualProfit.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`;
                }
                if (displayBreakEvenPoint) {
                    displayBreakEvenPoint.textContent = `€${currentBusiness.monthlyExpenses.toLocaleString('es-ES', { minimumFractionDigits: 2 })} (Ingresos Mensuales para cubrir gastos)`;
                }


                if (displayRecoveryTime) {
                    if (monthlyProfit > 0) {
                        const recoveryMonths = currentBusiness.initialInvestment / monthlyProfit;
                        displayRecoveryTime.textContent = `${recoveryMonths.toLocaleString('es-ES', { maximumFractionDigits: 1 })} meses`;
                    } else if (currentBusiness.initialInvestment > 0) {
                        displayRecoveryTime.textContent = 'Nunca (Beneficio Mensual <= 0)';
                    } else {
                        displayRecoveryTime.textContent = 'No aplica (Sin inversión inicial)';
                    }
                }

                localStorage.setItem('currentBusiness', JSON.stringify(currentBusiness));
            }


            // Carga inicial de métricas del dashboard y tablas
            updateDashboardAndTables();
            updateProjectionsDisplay();
            renderInitialExpenses(); // Render initial expenses on load

            // Lógica para cambiar de pestaña
            if (tabVentasBtn) { // Defensive check
                tabVentasBtn.addEventListener('click', () => {
                    if (contentVentas) contentVentas.classList.add('active');
                    if (contentInventario) contentInventario.classList.remove('active');
                    if (contentProyecciones) contentProyecciones.classList.remove('active');
                    tabVentasBtn.classList.add('active');
                    if (tabInventarioBtn) tabInventarioBtn.classList.remove('active');
                    if (tabProyeccionesBtn) tabProyeccionesBtn.classList.remove('active');
                });
            }

            if (tabInventarioBtn) { // Defensive check
                tabInventarioBtn.addEventListener('click', () => {
                    if (contentInventario) contentInventario.classList.add('active');
                    if (contentVentas) contentVentas.classList.remove('active');
                    if (contentProyecciones) contentProyecciones.classList.remove('active');
                    tabInventarioBtn.classList.add('active');
                    if (tabVentasBtn) tabVentasBtn.classList.remove('active');
                    if (tabProyeccionesBtn) tabProyeccionesBtn.classList.remove('active');
                });
            }

            if (tabProyeccionesBtn) { // Defensive check
                tabProyeccionesBtn.addEventListener('click', () => {
                    if (contentProyecciones) contentProyecciones.classList.add('active');
                    if (contentVentas) contentVentas.classList.remove('active');
                    if (contentInventario) contentInventario.classList.remove('active');
                    tabProyeccionesBtn.classList.add('active');
                    if (tabVentasBtn) tabVentasBtn.classList.remove('active');
                    if (tabInventarioBtn) tabInventarioBtn.classList.remove('active');
                });
            }

            // Manejar clic en botón Añadir Venta
            const addSaleButton = document.getElementById('addSaleButton');
            if (addSaleButton) {
                addSaleButton.addEventListener('click', () => {
                    const productSaleName = document.getElementById('newSaleProduct').value.trim();
                    const quantity = parseInt(document.getElementById('newSaleQuantity').value);
                    const price = parseFloat(document.getElementById('newSalePrice').value);
                    const addSaleMessage = document.getElementById('addSaleMessage');

                    if (!productSaleName || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
                        if (addSaleMessage) {
                            addSaleMessage.textContent = 'Por favor, ingresa datos válidos para la venta.';
                            addSaleMessage.className = 'form-message error';
                            addSaleMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    const today = new Date();
                    const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

                    const newSale = { product: productSaleName, quantity, price, date: dateString };
                    simulatedSales.unshift(newSale);
                    if (simulatedSales.length > 5) simulatedSales.pop();

                    totalSalesAmount += (quantity * price);
                    netProfitAmount += (quantity * price * 0.3); // Simular 30% de margen de beneficio

                    // Actualizar stock del producto vendido
                    const productToUpdate = simulatedProducts.find(p => p.name.toLowerCase() === productSaleName.toLowerCase());
                    if (productToUpdate && productToUpdate.stock > -1) { // Solo si es un producto físico
                        productToUpdate.stock -= quantity;
                        if (productToUpdate.stock < 0) productToUpdate.stock = 0; // Evitar stock negativo
                    } else if (productToUpdate && productToUpdate.stock === -1) {
                        // Es un servicio, no se afecta el stock físico
                        console.log(`Servicio "${productSaleName}" vendido, no se afecta el stock físico.`);
                    } else {
                        console.warn(`Producto "${productSaleName}" no encontrado en el inventario. No se actualizó el stock.`);
                    }

                    updateDashboardAndTables();
                    
                    document.getElementById('newSaleProduct').value = '';
                    document.getElementById('newSaleQuantity').value = '1';
                    document.getElementById('newSalePrice').value = '';

                    if (addSaleMessage) {
                        addSaleMessage.textContent = '¡Venta registrada exitosamente!';
                        addSaleMessage.className = 'form-message success';
                        addSaleMessage.classList.remove('hidden');
                        setTimeout(() => addSaleMessage.classList.add('hidden'), 3000);
                    }
                });
            }

            // Manejar clic en botón Añadir Producto
            const addProductButton = document.getElementById('addProductButton');
            if (addProductButton) {
                addProductButton.addEventListener('click', () => {
                    const name = document.getElementById('newProduct').value.trim();
                    const sku = document.getElementById('newProductSKU').value.trim();
                    const stock = parseInt(document.getElementById('newProductStock').value);
                    const price = parseFloat(document.getElementById('newProductPrice').value);
                    const addProductMessage = document.getElementById('addProductMessage');

                    if (!name || !sku || isNaN(stock) || isNaN(price) || price <= 0) {
                        if (addProductMessage) {
                            addProductMessage.textContent = 'Por favor, completa todos los campos del producto con datos válidos.';
                            addProductMessage.className = 'form-message error';
                            addProductMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    // Verificar si el SKU ya existe
                    if (simulatedProducts.some(p => p.sku.toLowerCase() === sku.toLowerCase())) {
                        if (addProductMessage) {
                            addProductMessage.textContent = 'Ya existe un producto con este SKU. Por favor, usa uno diferente.';
                            addProductMessage.className = 'form-message error';
                            addProductMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    const newProductId = 'P' + (simulatedProducts.length + 1).toString().padStart(3, '0');
                    const newProduct = { id: newProductId, name, sku, stock, price };
                    simulatedProducts.push(newProduct);

                    updateDashboardAndTables();

                    document.getElementById('newProduct').value = '';
                    document.getElementById('newProductSKU').value = '';
                    document.getElementById('newProductStock').value = '0';
                    document.getElementById('newProductPrice').value = '';

                    if (addProductMessage) {
                        addProductMessage.textContent = '¡Producto añadido exitosamente!';
                        addProductMessage.className = 'form-message success';
                        addProductMessage.classList.remove('hidden');
                        setTimeout(() => addProductMessage.classList.add('hidden'), 3000);
                    }
                });
            }

            // Manejar clic en botón Eliminar Stock
            const removeStockButton = document.getElementById('removeStockButton');
            if (removeStockButton) {
                removeStockButton.addEventListener('click', () => {
                    const sku = document.getElementById('removeProductSKU').value.trim();
                    const quantityToRemove = parseInt(document.getElementById('removeQuantity').value);
                    const removeStockMessage = document.getElementById('removeStockMessage');

                    if (!sku || isNaN(quantityToRemove) || quantityToRemove <= 0) {
                        if (removeStockMessage) {
                            removeStockMessage.textContent = 'Por favor, introduce un SKU y una cantidad válida.';
                            removeStockMessage.className = 'form-message error';
                            removeStockMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    const productIndex = simulatedProducts.findIndex(p => p.sku.toLowerCase() === sku.toLowerCase());

                    if (productIndex === -1) {
                        if (removeStockMessage) {
                            removeStockMessage.textContent = 'Producto no encontrado con ese SKU.';
                            removeStockMessage.className = 'form-message error';
                            removeStockMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    const product = simulatedProducts[productIndex];

                    if (product.stock === -1) { // Servicio, no se puede eliminar stock
                        if (removeStockMessage) {
                            removeStockMessage.textContent = `"${product.name}" es un servicio, no se puede eliminar stock físico.`;
                            removeStockMessage.className = 'form-message error';
                            removeStockMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    if (product.stock < quantityToRemove) {
                        if (removeStockMessage) {
                            removeStockMessage.textContent = `No hay suficiente stock. Solo hay ${product.stock} unidades.`;
                            removeStockMessage.className = 'form-message error';
                            removeStockMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    product.stock -= quantityToRemove;
                    updateDashboardAndTables();

                    document.getElementById('removeProductSKU').value = '';
                    document.getElementById('removeQuantity').value = '1';

                    if (removeStockMessage) {
                        removeStockMessage.textContent = `Stock de "${product.name}" reducido en ${quantityToRemove} unidades.`;
                        removeStockMessage.className = 'form-message success';
                        removeStockMessage.classList.remove('hidden');
                        setTimeout(() => removeStockMessage.classList.add('hidden'), 3000);
                    }
                });
            }

            // Manejar clic en botón Calcular Proyecciones
            const calculateProjectionsButtonEl = document.getElementById('calculateProjectionsButton');
            if (calculateProjectionsButtonEl) {
                calculateProjectionsButtonEl.addEventListener('click', () => {
                    const name = businessNameInput ? businessNameInput.value.trim() : '';
                    const monthlyExp = monthlyExpensesInput ? parseFloat(monthlyExpensesInput.value) : 0;
                    const monthlyRev = monthlyRevenueInput ? parseFloat(monthlyRevenueInput.value) : 0;

                    if (!name || isNaN(monthlyExp) || monthlyExp < 0 || isNaN(monthlyRev) || monthlyRev < 0) {
                        if (projectionMessage) {
                            projectionMessage.textContent = 'Por favor, completa todos los campos con valores válidos.';
                            projectionMessage.className = 'form-message error';
                            projectionMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    currentBusiness = {
                        name: name,
                        initialInvestment: calculateTotalInitialInvestment(), // Now calculated
                        monthlyExpenses: monthlyExp,
                        monthlyRevenue: monthlyRev
                    };

                    updateProjectionsDisplay();
                    if (projectionMessage) {
                        projectionMessage.textContent = '¡Proyecciones actualizadas!';
                        projectionMessage.className = 'form-message success';
                        projectionMessage.classList.remove('hidden');
                        setTimeout(() => projectionMessage.classList.add('hidden'), 3000);
                    }
                });
            }

            // Manejar clic en botón Añadir Gasto de Inversión
            const addInitialExpenseButtonEl = document.getElementById('addInitialExpenseButton');
            if (addInitialExpenseButtonEl) {
                addInitialExpenseButtonEl.addEventListener('click', () => {
                    const name = initialExpenseNameInput ? initialExpenseNameInput.value.trim() : '';
                    const amount = initialExpenseAmountInput ? parseFloat(initialExpenseAmountInput.value) : 0;
                    
                    if (!name || isNaN(amount) || amount <= 0) {
                        if (addInitialExpenseMessage) {
                            addInitialExpenseMessage.textContent = 'Por favor, introduce un nombre y un monto válido para el gasto.';
                            addInitialExpenseMessage.className = 'form-message error';
                            addInitialExpenseMessage.classList.remove('hidden');
                        }
                        return;
                    }

                    initialExpenses.push({ name, amount });
                    localStorage.setItem('initialExpenses', JSON.stringify(initialExpenses));

                    if (initialExpenseNameInput) initialExpenseNameInput.value = '';
                    if (initialExpenseAmountInput) initialExpenseAmountInput.value = '';

                    renderInitialExpenses();
                    updateProjectionsDisplay(); // Re-calculate and display total investment and projections

                    if (addInitialExpenseMessage) {
                        addInitialExpenseMessage.textContent = 'Gasto de inversión añadido.';
                        addInitialExpenseMessage.className = 'form-message success';
                        addInitialExpenseMessage.classList.remove('hidden');
                        setTimeout(() => addInitialExpenseMessage.classList.add('hidden'), 3000);
                    }
                });
            }            // Lógica de cerrar sesión
            const logout = () => {
                // Limpiar todos los datos de autenticación usando la API
                if (window.authAPI) {
                    window.authAPI.clearAuthData();
                }
                
                // Redirigir a la página principal
                alert('Sesión cerrada. Serás redirigido a la página de inicio.');
                window.location.href = '/';
            };

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }        });
    </script>

    <!-- Sistema de Divisas y PDF -->
    <script>
        // ============================================================
        // SISTEMA DE DIVISAS GLOBAL
        // ============================================================
        
        // Tasas de conversión (simuladas - en producción vendrían de una API)
        const exchangeRates = {
            USD: 1.0,       // Base
            EUR: 0.85,      // Euro
            GBP: 0.73,      // Libra Esterlina
            JPY: 110.0,     // Yen Japonés
            CAD: 1.25,      // Dólar Canadiense
            AUD: 1.35,      // Dólar Australiano
            CHF: 0.92,      // Franco Suizo
            MXN: 20.0,      // Peso Mexicano
            BRL: 5.5,       // Real Brasileño
            ARS: 350.0,     // Peso Argentino
            COP: 4000.0,    // Peso Colombiano
            PEN: 3.8        // Sol Peruano
        };

        // Símbolos de divisas
        const currencySymbols = {
            USD: '$',
            EUR: '€',
            GBP: '£',
            JPY: '¥',
            CAD: 'C$',
            AUD: 'A$',
            CHF: '₣',
            MXN: '$',
            BRL: 'R$',
            ARS: '$',
            COP: '$',
            PEN: 'S/'
        };        // Sistema de divisas global
        window.currencySystem = {
            currentCurrency: localStorage.getItem('selectedCurrency') || 'USD',
            userCurrency: localStorage.getItem('selectedCurrency') || 'USD',
            
            // Convertir entre divisas
            convert: function(amount, fromCurrency, toCurrency) {
                if (fromCurrency === toCurrency) {
                    return Promise.resolve({
                        original: { amount, currency: fromCurrency },
                        converted: { amount, currency: toCurrency }
                    });
                }
                
                try {
                    // Convertir a USD primero si no es USD
                    const amountInUSD = fromCurrency === 'USD' ? amount : amount / exchangeRates[fromCurrency];
                    
                    // Convertir de USD a la divisa objetivo
                    const convertedAmount = toCurrency === 'USD' ? amountInUSD : amountInUSD * exchangeRates[toCurrency];
                    
                    return Promise.resolve({
                        original: { amount, currency: fromCurrency },
                        converted: { amount: convertedAmount, currency: toCurrency }
                    });
                } catch (error) {
                    console.error('Error en conversión de divisas:', error);
                    return Promise.resolve({
                        original: { amount, currency: fromCurrency },
                        converted: { amount, currency: fromCurrency }
                    });
                }
            },
            
            // Formatear cantidad con símbolo de divisa
            formatAmount: function(amount, currency = null) {
                const targetCurrency = currency || this.currentCurrency;
                const symbol = currencySymbols[targetCurrency] || '$';
                
                // Formatear según la divisa
                let formattedAmount;
                if (targetCurrency === 'JPY') {
                    // Yen sin decimales
                    formattedAmount = Math.round(amount).toLocaleString();
                } else {
                    // Otras divisas con 2 decimales
                    formattedAmount = amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
                
                return `${symbol}${formattedAmount}`;
            },
              // Cambiar divisa actual
            changeCurrency: function(newCurrency) {
                this.currentCurrency = newCurrency;
                this.userCurrency = newCurrency;
                localStorage.setItem('selectedCurrency', newCurrency);
                this.updateAllPrices();
                
                // Disparar evento personalizado
                document.dispatchEvent(new CustomEvent('currency-changed', {
                    detail: { currency: newCurrency }
                }));
            },
              // Actualizar todos los precios en la página
            updateAllPrices: function() {
                const priceElements = document.querySelectorAll('[data-amount]');
                priceElements.forEach(async element => {
                    const baseAmount = parseFloat(element.getAttribute('data-amount'));
                    const baseCurrency = element.getAttribute('data-currency') || 'USD';
                    
                    if (!isNaN(baseAmount)) {
                        try {
                            const converted = await this.convert(baseAmount, baseCurrency, this.currentCurrency);
                            if (converted && converted.converted) {
                                element.textContent = this.formatAmount(converted.converted.amount);
                            } else {
                                element.textContent = this.formatAmount(baseAmount, baseCurrency);
                            }
                        } catch (error) {
                            console.error('Error actualizando precio:', error);
                            element.textContent = this.formatAmount(baseAmount, baseCurrency);
                        }
                    }
                });
                
                // Actualizar símbolo en inputs de precio
                this.updatePriceInputPlaceholders();
            },
            
            // Actualizar placeholders de inputs
            updatePriceInputPlaceholders: function() {
                const priceInputs = document.querySelectorAll('input[placeholder*="precio"], input[placeholder*="Precio"]');
                const symbol = currencySymbols[this.currentCurrency] || '$';
                priceInputs.forEach(input => {
                    const placeholder = input.getAttribute('placeholder');
                    if (placeholder) {
                        input.setAttribute('placeholder', placeholder.replace(/[$€£¥₣RS\/C\$A\$]+/, symbol));
                    }
                });
            }
        };

        // ============================================================
        // SISTEMA DE GENERACIÓN DE PDF
        // ============================================================
        
        window.pdfSystem = {
            generatePDF: function(type = 'complete') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuración inicial
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                let yPosition = margin;
                
                // Información del usuario
                const userEmail = localStorage.getItem('userEmail') || 'usuario@ejemplo.com';
                const userName = localStorage.getItem('userName') || 'Usuario';
                const currentDate = new Date().toLocaleDateString('es-ES');
                const currentCurrency = window.currencySystem.currentCurrency;
                
                // Header del documento
                doc.setFontSize(20);
                doc.setTextColor(13, 148, 136); // Teal-600
                doc.text('REPORTE EMPRESARIAL MALINOISE', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Usuario: ${userName} (${userEmail})`, margin, yPosition);
                yPosition += 8;
                doc.text(`Fecha: ${currentDate}`, margin, yPosition);
                yPosition += 8;
                doc.text(`Divisa: ${currentCurrency}`, margin, yPosition);
                yPosition += 15;
                
                // Métricas principales
                doc.setFontSize(16);
                doc.setTextColor(13, 148, 136);
                doc.text('MÉTRICAS PRINCIPALES', margin, yPosition);
                yPosition += 12;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                
                // Obtener métricas actuales
                const totalSalesElement = document.getElementById('totalSales');
                const totalProductsElement = document.getElementById('totalProductsCount');
                const netProfitElement = document.getElementById('netProfit');
                
                const totalSales = totalSalesElement ? totalSalesElement.textContent : 'N/A';
                const totalProducts = totalProductsElement ? totalProductsElement.textContent : 'N/A';
                const netProfit = netProfitElement ? netProfitElement.textContent : 'N/A';
                
                doc.text(`• Ventas Totales (Mes): ${totalSales}`, margin, yPosition);
                yPosition += 8;
                doc.text(`• Productos en Stock: ${totalProducts}`, margin, yPosition);
                yPosition += 8;
                doc.text(`• Ganancia Neta (Mes): ${netProfit}`, margin, yPosition);
                yPosition += 20;
                
                // Historial de ventas
                doc.setFontSize(16);
                doc.setTextColor(13, 148, 136);
                doc.text('HISTORIAL DE VENTAS', margin, yPosition);
                yPosition += 12;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                // Headers de tabla
                doc.text('Fecha', margin, yPosition);
                doc.text('Producto', margin + 40, yPosition);
                doc.text('Cantidad', margin + 100, yPosition);
                doc.text('Precio Unit.', margin + 130, yPosition);
                doc.text('Total', margin + 160, yPosition);
                yPosition += 8;
                
                // Línea separadora
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 5;
                
                // Datos de ventas (simulados o reales)
                const salesData = JSON.parse(localStorage.getItem('simulatedSales') || '[]');
                if (salesData.length === 0) {
                    // Datos de ejemplo si no hay ventas
                    const exampleSales = [
                        { date: currentDate, product: 'Producto Ejemplo 1', quantity: 2, price: 25.00, total: 50.00 },
                        { date: currentDate, product: 'Producto Ejemplo 2', quantity: 1, price: 75.00, total: 75.00 }
                    ];
                    
                    exampleSales.forEach(sale => {
                        const convertedPrice = window.currencySystem.convert(sale.price, 'USD', currentCurrency);
                        const convertedTotal = window.currencySystem.convert(sale.total, 'USD', currentCurrency);
                        
                        doc.text(sale.date, margin, yPosition);
                        doc.text(sale.product.substring(0, 20), margin + 40, yPosition);
                        doc.text(sale.quantity.toString(), margin + 100, yPosition);
                        doc.text(window.currencySystem.formatAmount(convertedPrice), margin + 130, yPosition);
                        doc.text(window.currencySystem.formatAmount(convertedTotal), margin + 160, yPosition);
                        yPosition += 6;
                    });
                } else {
                    salesData.slice(0, 15).forEach(sale => { // Limitar a 15 entradas
                        doc.text(sale.date || currentDate, margin, yPosition);
                        doc.text((sale.product || sale.name || 'N/A').substring(0, 20), margin + 40, yPosition);
                        doc.text((sale.quantity || 1).toString(), margin + 100, yPosition);
                        doc.text(window.currencySystem.formatAmount(sale.price || 0), margin + 130, yPosition);
                        doc.text(window.currencySystem.formatAmount(sale.total || sale.price || 0), margin + 160, yPosition);
                        yPosition += 6;
                    });
                }
                
                // Nueva página si es necesario
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                // Inventario
                yPosition += 15;
                doc.setFontSize(16);
                doc.setTextColor(13, 148, 136);
                doc.text('INVENTARIO ACTUAL', margin, yPosition);
                yPosition += 12;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                // Headers de inventario
                doc.text('Producto', margin, yPosition);
                doc.text('SKU', margin + 60, yPosition);
                doc.text('Stock', margin + 100, yPosition);
                doc.text('Precio', margin + 130, yPosition);
                doc.text('Valor Total', margin + 160, yPosition);
                yPosition += 8;
                
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 5;
                
                // Datos de inventario
                const inventoryData = JSON.parse(localStorage.getItem('simulatedProducts') || '[]');
                if (inventoryData.length === 0) {
                    doc.text('No hay productos en inventario', margin, yPosition);
                    yPosition += 10;
                } else {
                    inventoryData.slice(0, 20).forEach(product => {
                        const convertedPrice = window.currencySystem.convert(product.price || 0, 'USD', currentCurrency);
                        const totalValue = convertedPrice * (product.stock || 0);
                        
                        doc.text((product.name || 'N/A').substring(0, 20), margin, yPosition);
                        doc.text((product.sku || 'N/A').substring(0, 15), margin + 60, yPosition);
                        doc.text((product.stock || 0).toString(), margin + 100, yPosition);
                        doc.text(window.currencySystem.formatAmount(convertedPrice), margin + 130, yPosition);
                        doc.text(window.currencySystem.formatAmount(totalValue), margin + 160, yPosition);
                        yPosition += 6;
                    });
                }
                
                // Footer
                yPosition = doc.internal.pageSize.height - 20;
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Generado por Malinoise Web App', pageWidth / 2, yPosition, { align: 'center' });
                
                // Descargar PDF
                const fileName = `Malinoise_Reporte_${currentDate.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
            }
        };

        // ============================================================
        // INICIALIZACIÓN
        // ============================================================
          document.addEventListener('DOMContentLoaded', function() {
            // Configurar selector de divisas
            const currencySelector = document.getElementById('currency-selector');
            if (currencySelector) {
                // Establecer divisa actual
                currencySelector.value = window.currencySystem.currentCurrency;
                
                // Event listener para cambio de divisa
                currencySelector.addEventListener('change', function() {
                    window.currencySystem.changeCurrency(this.value);
                });
            }
            
            // Configurar botón de PDF
            const pdfButton = document.getElementById('download-pdf-btn');
            if (pdfButton) {
                pdfButton.addEventListener('click', function() {
                    // Notificación de descarga
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    notification.innerHTML = '<i class="fas fa-check mr-2"></i>Generando reporte PDF...';
                    document.body.appendChild(notification);
                    
                    // Generar PDF
                    setTimeout(() => {
                        window.pdfSystem.generatePDF();
                        notification.innerHTML = '<i class="fas fa-download mr-2"></i>¡Reporte descargado!';
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 2000);
                    }, 500);
                });
            }
            
            // Actualizar precios al cargar (con retraso para asegurar que todo esté cargado)
            setTimeout(() => {
                window.currencySystem.updateAllPrices();
            }, 1000);
        });
    </script>
    
    <!-- Script principal simple para desarrollo -->
    <script src="/js/app-simple.js"></script>
    
    <!-- Script específico del dashboard -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/';
                return;
            }

            // Mostrar/ocultar enlace de administración según el rol
            const adminLink = document.getElementById('admin-link');
            if (adminLink) {
                if (window.auth.isCEO()) {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }
            }

            // Inicializar selector de divisas
            const currencyContainer = document.getElementById('currency-selector-container');
            if (currencyContainer && window.currencySystem) {
                currencyContainer.appendChild(window.currencySystem.createCurrencySelector());
            }

            // Mostrar información del usuario
            const userInfo = document.getElementById('userInfo');
            if (userInfo && window.auth.currentUser) {
                userInfo.textContent = `Conectado como: ${window.auth.currentUser.name} (${window.auth.currentUser.email})`;
            }

            // Cargar datos del dashboard con conversión de divisas
            loadDashboardData();

            // Configurar actualizaciones en tiempo real de divisas
            document.addEventListener('currency-changed', () => {
                updateDashboardAmounts();
            });

            // Las demás funciones del dashboard permanecen igual...
            // (código del dashboard original aquí)
        });

        // Función para cargar datos del dashboard con soporte para divisas
        async function loadDashboardData() {
            try {
                // Cargar datos locales por ahora (en el futuro será desde la API)
                const salesData = JSON.parse(localStorage.getItem('salesData') || '[]');
                const inventoryData = JSON.parse(localStorage.getItem('inventoryData') || '[]');
                
                updateDashboardMetrics(salesData, inventoryData);
                updateSalesTable(salesData);
                updateInventoryTable(inventoryData);
                
            } catch (error) {
                console.error('Error cargando datos del dashboard:', error);
                window.notifications.error('Error cargando datos del dashboard');
            }
        }

        // Función para actualizar métricas con conversión de divisas
        async function updateDashboardMetrics(sales, inventory) {
            const totalSales = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalProducts = inventory.reduce((sum, item) => sum + (item.stock || 0), 0);
            const totalCosts = inventory.reduce((sum, item) => sum + ((item.cost || 0) * (item.stock || 0)), 0);
            const netProfit = totalSales - totalCosts;

            // Actualizar elementos con soporte para divisas
            updateAmountElement('totalSales', totalSales);
            updateAmountElement('netProfit', netProfit);
            
            const totalProductsEl = document.getElementById('totalProductsCount');
            if (totalProductsEl) {
                totalProductsEl.textContent = totalProducts.toString();
            }
        }

        // Función auxiliar para actualizar elementos con divisas
        function updateAmountElement(elementId, amount, currency = 'EUR') {
            const element = document.getElementById(elementId);
            if (element) {
                element.setAttribute('data-amount', amount);
                element.setAttribute('data-currency', currency);
                element.textContent = window.currencySystem.formatAmount(amount, currency);
            }
        }

        // Función para actualizar todos los montos cuando cambie la divisa
        function updateDashboardAmounts() {
            document.querySelectorAll('[data-amount][data-currency]').forEach(async (element) => {
                const amount = parseFloat(element.dataset.amount);
                const originalCurrency = element.dataset.currency;
                
                if (originalCurrency !== window.currencySystem.userCurrency) {
                    const converted = await window.currencySystem.convert(amount, originalCurrency, window.currencySystem.userCurrency);
                    if (converted) {
                        element.textContent = window.currencySystem.formatAmount(converted.converted.amount);
                    }
                } else {
                    element.textContent = window.currencySystem.formatAmount(amount, originalCurrency);
                }
            });
        }

        // Función global para generar PDF del historial de transacciones
        window.downloadTransactionsPDF = function() {
            const salesData = JSON.parse(localStorage.getItem('salesData') || '[]');
            window.pdfSystem.generatePDF('transactions', salesData, 'Historial de Ventas');
        };

        // Función global para generar PDF del inventario
        window.downloadInventoryPDF = function() {
            const inventoryData = JSON.parse(localStorage.getItem('inventoryData') || '[]');
            window.pdfSystem.generatePDF('inventory', inventoryData, 'Reporte de Inventario');
        };

        // Resto del código del dashboard original...
        // (todas las funciones de gestión de ventas, inventario, proyecciones, etc.)
    </script>
</body>
</html>
